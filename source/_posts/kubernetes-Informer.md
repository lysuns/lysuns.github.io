---
title: kubernetes-Informer详解
date: 2020-07-11 13:11:03
tags: kubernetes
---

# 导语
> 本文将对kubernetes informer机制进行详细剖析，从全局出发，从使用方式、举例说明到源码剖析，力争讲清楚informer都干了些什么、为什么要这样干。从informer的实现方式总结出使用kubernetes client可能遇到情况。

> 《详解系列》是笔者从喜马拉雅中《猫哥详说红楼梦》得到的启发，在这篇音频节目中，猫哥一字一句的解释了红楼梦的故事，处处都透出一个"详"字，让初读者能很清楚、很容易、毫无障碍的了解红楼梦到底讲述了什么。《详解系列》也将以此作为立足点，由粗到细，并能讲多细，就讲多细；所举示例，尽量都能保证独立运行。

> 本文是笔者个人理解，若有纰漏之处，还请指正(^.^)。

# Informer是什么（1）。
首先，Informer是给客户端访问kubernetes中资源的一种工具，注意，它不属于服务器端，仅用于客户端来访问、观察apiserver的对象。在kubernetes生态中，如果作为客户端想要访问k8s资源，几乎就离不开informer。
<!-- more -->

我们先从客户端角度出发，试想一下，如果没有informer，我们想要获取当前kubernetes中的资源情况，并实时得到资源对象的变化（如增删改），就得自己发起一个http短连接来获取当前资源对象（apiserver 的GET接口），以及一个http长连接来实时watch资源对象的变换（apiserver的watch接口）。这样手动实现会遇到以下几个不好的地方，一个是每次要获取对象的时候，都要发起一次http链接，这对apiserver会带来压力；另外一个是，当我们watch对象变化时，由于网络的不稳定性，可能出现了连接断开、超时等异常情况，这样我们得重新维护并且尽量不遗失这些对象的变化事件。那么总结一下，如果我们想要稳定的观察一个kubernetes 资源对象的一切变化，需要实现哪些功能：
1. 发起一个短连接，访问apiserver的GET接口来获取当前集群中所有存在的对象。
2. 维持一个长连接，访问apiserver的WATCH接口实时watch对象的变化。
3. 维护一个缓存池，当我们要访问某个对象时，不需要重新发起http连接来获取对象的情况，而是直接从缓存池中拿到这个对象。
4. 处理各种异常情况，来维持这个缓冲池中对象的状态与apiserver中对象的状态保持一致。

而informer机制，大致来说就是实现了以上4点。informer底层实现上也是用一个短连接来LIST资源对象，用一个长连接来WATCH对象的变化，并且维护了一个对象缓存池，informer屏蔽了很多访问kubernetes资源的细节，并将其总结了成了几个简单接口以及3个钩子函数。下面我们首先来实现一个使用informer接口的简单客户端，看看informer是怎么玩的。

# Informer的使用示例。
我们将使用informer来实现一个简单的pod controller。该controller观察所有pod的变化事件，并且打印出这些事件。

# Informer实现机制
# Informer是什么（2）
